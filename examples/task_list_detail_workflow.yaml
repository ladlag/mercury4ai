# List Page + Detail Pages Workflow Example
# This example shows how to handle the common pattern of:
# 1. Crawling a list page to extract URLs
# 2. Then crawling each detail page

# ============================================
# STEP 1: Extract URLs from List Page
# ============================================
# Import and run this task first to get all product URLs

name: "Step 1: Extract Product URLs from List"
description: |
  从列表页提取所有产品的详情页链接
  Extract all product detail page URLs from list page
  
urls:
  - https://example.com/products  # Replace with your list page URL

crawl_config:
  verbose: true
  wait_for: ".product-list, .item-list"  # Wait for list to load
  
  # Optional: Handle dynamic loading
  js_code: |
    // Scroll to bottom to trigger lazy loading
    window.scrollTo(0, document.body.scrollHeight);
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    // Click "Load More" button if exists
    const loadMore = document.querySelector('.load-more, .show-more');
    if (loadMore) {
      loadMore.click();
      await new Promise(resolve => setTimeout(resolve, 2000));
    }

# LLM Configuration (or use defaults from .env)
llm_provider: openai
llm_model: deepseek-chat
llm_params:
  api_key: "your-deepseek-api-key"  # Or set DEFAULT_LLM_API_KEY in .env
  base_url: "https://api.deepseek.com"
  temperature: 0.1

prompt_template: |
  请从这个产品列表页面中提取以下信息：
  1. 所有产品的标题
  2. 每个产品的详情页链接URL（完整的URL，包含https://）
  3. 产品的简短描述或预览信息
  
  要求：
  - 链接必须是完整的绝对URL
  - 如果链接是相对路径，请补全为绝对路径
  - 按照页面上出现的顺序排列
  
  以JSON格式返回结果。

output_schema:
  type: object
  properties:
    page_title:
      type: string
      description: 列表页标题
    items:
      type: array
      description: 产品列表
      items:
        type: object
        properties:
          title:
            type: string
            description: 产品标题
          url:
            type: string
            description: 产品详情页URL（完整URL）
          preview:
            type: string
            description: 产品预览描述
        required:
          - title
          - url
    total_count:
      type: integer
      description: 提取到的产品总数
  required:
    - items

deduplication_enabled: true
fallback_download_enabled: true

# ============================================
# After running Step 1:
# 1. Get results: GET /api/runs/{run_id}/result
# 2. Extract URLs from structured_data.items[].url
# 3. Create Step 2 task with those URLs
# ============================================

---
# ============================================
# STEP 2: Crawl Detail Pages
# ============================================
# Create this task after getting URLs from Step 1
# Replace the urls list with actual URLs extracted from Step 1

name: "Step 2: Extract Product Details"
description: |
  从详情页提取完整的产品信息
  Extract complete product information from detail pages

# Replace these URLs with the ones extracted from Step 1
urls:
  - https://example.com/product/1
  - https://example.com/product/2
  - https://example.com/product/3
  # Add more URLs here (extracted from Step 1 results)

crawl_config:
  verbose: true
  wait_for: ".product-detail, .item-detail"  # Wait for detail content
  
  # Optional: Handle image galleries or tabs
  js_code: |
    // Click all tabs to load hidden content
    const tabs = document.querySelectorAll('.tab, .product-tab');
    for (const tab of tabs) {
      tab.click();
      await new Promise(resolve => setTimeout(resolve, 500));
    }

# LLM Configuration (or use defaults from .env)
llm_provider: openai
llm_model: deepseek-chat
llm_params:
  api_key: "your-deepseek-api-key"
  base_url: "https://api.deepseek.com"
  temperature: 0.1

prompt_template: |
  请从这个产品详情页中提取完整信息：
  
  1. 产品名称
  2. 产品价格（包含货币符号）
  3. 产品详细描述
  4. 规格参数（尺寸、重量、材质等）
  5. 库存状态
  6. 产品图片URL列表
  7. 用户评分（如果有）
  8. 品牌信息
  
  数据清洗要求：
  - 价格统一格式：¥1,234.56
  - 移除HTML标签
  - 规格参数以结构化对象返回
  - 图片URL必须是完整的绝对路径
  
  以JSON格式返回结果。

output_schema:
  type: object
  properties:
    name:
      type: string
      description: 产品名称
    brand:
      type: string
      description: 品牌
    price:
      type: string
      description: 价格（格式：¥1,234.56）
    description:
      type: string
      description: 产品详细描述
    specifications:
      type: object
      description: 规格参数
      properties:
        size:
          type: string
          description: 尺寸
        weight:
          type: string
          description: 重量
        material:
          type: string
          description: 材质
      additionalProperties: true
    stock_status:
      type: string
      enum: ["有货", "缺货", "预订", "停产"]
      description: 库存状态
    images:
      type: array
      items:
        type: string
      description: 产品图片URL列表
    rating:
      type: number
      description: 用户评分（0-5）
    reviews_count:
      type: integer
      description: 评论数量
  required:
    - name
    - price

# Important: Enable deduplication to avoid re-crawling
deduplication_enabled: true

# Enable fallback download for product images
fallback_download_enabled: true
fallback_max_size_mb: 10

# ============================================
# Usage Workflow:
# 
# 1. Import and run Step 1 task:
#    curl -X POST http://localhost:8000/api/tasks/import?format=yaml \
#      -H "X-API-Key: your-api-key" --data-binary @task_list_detail_workflow.yaml
#
# 2. Get Step 1 results:
#    curl http://localhost:8000/api/runs/{run_id}/result \
#      -H "X-API-Key: your-api-key"
#
# 3. Extract URLs from Step 1 structured_data
#
# 4. Create Step 2 task with extracted URLs
#    (Modify the urls list in Step 2 section)
#
# 5. Import and run Step 2 task
#
# 6. Get complete product details from Step 2 results
# ============================================
